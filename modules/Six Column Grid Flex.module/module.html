{% import '../macros.html' %}

{% set custom_name = module.custom_name | default(name) %}
{% set spacing = (module.spacing | int(26) ) // 2 %}
{% set card_count = module.cards|length %}
{% set column_class = 'kl-card-grid--' ~ card_count ~ '-columns' %}

{% set bg_color = module.card_styling.background_color.color | default('#ffffff') %}
{% set bg_opacity = module.card_styling.background_opacity | default(100) %}
{% set border_color = module.card_styling.border_color.color | default('#e0e0e0') %}
{% set border_radius = module.card_styling.border_radius | default(8) %}
{% set bg_blur = module.card_styling.background_blur | default(0) %}

{# Container width settings #}
{% set max_width = module.container_max_width | default(1450) %}
{% set width_unit = module.container_width_unit | default('px') %}
{% set center_container = module.container_center | default(true) %}
{% set container_style = '' %}

{% if module.enable_container_width %}
  {% set container_style = 'max-width: ' ~ max_width ~ width_unit ~ ';' %}
  {% if center_container %}
    {% set container_style = container_style ~ ' margin: 0 auto;' %}
  {% endif %}
{% endif %}

<div class="kl-card-grid {{ column_class }}" id="{{ custom_name }}" data-module-id="{{ name }}" {% if container_style %}style="{{ container_style }}"{% endif %}>
  {% if module.card_search.enabled %}
    <div class="kl-card__search-container" style="margin: 0 0 {{ spacing * 2 }}px;">
      <label for="{{ custom_name }}_search">{{ module.card_search.search_label }}</label>
      <input type="search" id="{{ custom_name }}_search" name="{{ custom_name }}_search">
    </div>
  {% endif %}
  <div {% if module.overwrite_spacing %}style="margin: -{{ spacing }}px;"{% endif %}>
    {% for item in module.cards %}

      <div class="kl-card-grid__card-wrapper"
           {% if module.overwrite_spacing %} 
             style="padding: {{ spacing }}px;"
           {% endif %}
        >
        <div class="kl-card-grid__card" 
             {% if module.enable_card_styling %}
               style="background-color: {{ bg_color }}; 
                      background-color: rgba({{ bg_color|convert_rgb }}, {{ bg_opacity / 100 }}); 
                      border-color: {{ border_color }}; 
                      border-radius: {{ border_radius }}px;
                      {% if bg_blur > 0 %}backdrop-filter: blur({{ bg_blur }}px);{% endif %}"
             {% endif %}>
          {% if item.image.src %}
            {% set style = 'background-image: url(%s);'|format(item.image.src) %}
            {% call render_link(item.anchor, 'kl-card-grid__image', style, true) %}
              <span class="kl-card-grid__image-description" role="img" aria-label="{{item.image.alt}}"> </span>
            {% endcall %}
          {% endif %}
          <div class="kl-card-grid__content">
            {% if item.preheader %}
              <span class="kl-card-grid__preheader">{{ item.preheader }}</span>
            {% endif %}
            {{ item.content }}
          </div>
        </div>
      </div>
    {% endfor %}
    {% if module.card_search.enabled %}
      <div class="kl-card__search__no-match" style="margin: {{ spacing * 2 }}px {{ spacing }}px;">
        <span>{{ module.card_search.no_match_message }}</span>
      </div>
    {% endif %}
  </div>
</div>
